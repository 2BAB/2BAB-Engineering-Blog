<!DOCTYPE html><html lang="en" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="构建指北 #8 AppPlugin 加了代理？" /><meta name="author" content="2BAB" /><meta property="og:locale" content="en_US" /><meta name="description" content="『构建指北』是探索 Android 构建相关的一系列文章，涵盖了 Gradle、Android Gradle Plugin、Kotlin Script 等工具，以及相关架构上的应用。以发现问题解决问题为出发点，传递新知提高生产效率为落脚点。" /><meta property="og:description" content="『构建指北』是探索 Android 构建相关的一系列文章，涵盖了 Gradle、Android Gradle Plugin、Kotlin Script 等工具，以及相关架构上的应用。以发现问题解决问题为出发点，传递新知提高生产效率为落脚点。" /><link rel="canonical" href="https://2bab.me//2020/03/20/daily-of-agp-appplugin-delegate" /><meta property="og:url" content="https://2bab.me//2020/03/20/daily-of-agp-appplugin-delegate" /><meta property="og:site_name" content="2BAB’s Engineering Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-03-20T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="构建指北 #8 AppPlugin 加了代理？" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@2BAB" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"2BAB","url":"https://2bab.me/"},"dateModified":"2020-03-20T00:00:00+00:00","datePublished":"2020-03-20T00:00:00+00:00","description":"『构建指北』是探索 Android 构建相关的一系列文章，涵盖了 Gradle、Android Gradle Plugin、Kotlin Script 等工具，以及相关架构上的应用。以发现问题解决问题为出发点，传递新知提高生产效率为落脚点。","headline":"构建指北 #8 AppPlugin 加了代理？","mainEntityOfPage":{"@type":"WebPage","@id":"https://2bab.me//2020/03/20/daily-of-agp-appplugin-delegate"},"url":"https://2bab.me//2020/03/20/daily-of-agp-appplugin-delegate"}</script><title> 构建指北 #8 AppPlugin 加了代理？ - 2BAB&#39;s Engineering Blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" title="2BAB's Engineering Blog" href="/atom.xml"><link rel="alternate" type="application/json" title="2BAB's Engineering Blog" href="https://2bab.me//feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.6;font-size:1.1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}p code{background:#f0f0f0;padding-left:0.2rem;padding-right:0.2rem}code{padding:.1rem}pre code{border:none}pre{border:1px solid #eee;padding:1rem;overflow-x:auto}blockquote{overflow-x:auto}table{display:inline-block;overflow:auto;border-collapse:collapse}table tr th,table tr td{border:1px solid #eee;padding:0.5rem}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:1rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}body{font-size:1rem}header{padding:0rem}section{padding:1rem 0 0 0}.post ul{margin-left:1rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}.highlight .hll{background-color:#ffffcc}.highlight .c{color:#999988;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{color:#000000;font-weight:bold}.highlight .o{color:#000000;font-weight:bold}.highlight .cm{color:#999988;font-style:italic}.highlight .cp{color:#999999;font-weight:bold;font-style:italic}.highlight .c1{color:#999988;font-style:italic}.highlight .cs{color:#999999;font-weight:bold;font-style:italic}.highlight .gd{color:#000000;background-color:#ffdddd}.highlight .ge{color:#000000;font-style:italic}.highlight .gr{color:#aa0000}.highlight .gh{color:#999999}.highlight .gi{color:#000000;background-color:#ddffdd}.highlight .go{color:#888888}.highlight .gp{color:#555555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaaaaa}.highlight .gt{color:#aa0000}.highlight .kc{color:#000000;font-weight:bold}.highlight .kd{color:#000000;font-weight:bold}.highlight .kn{color:#000000;font-weight:bold}.highlight .kp{color:#000000;font-weight:bold}.highlight .kr{color:#000000;font-weight:bold}.highlight .kt{color:#445588;font-weight:bold}.highlight .m{color:#009999}.highlight .s{color:#d01040}.highlight .na{color:#008080}.highlight .nb{color:#0086B3}.highlight .nc{color:#445588;font-weight:bold}.highlight .no{color:#008080}.highlight .nd{color:#3c5d5d;font-weight:bold}.highlight .ni{color:#800080}.highlight .ne{color:#990000;font-weight:bold}.highlight .nf{color:#990000;font-weight:bold}.highlight .nl{color:#990000;font-weight:bold}.highlight .nn{color:#555555}.highlight .nt{color:#000080}.highlight .nv{color:#008080}.highlight .ow{color:#000000;font-weight:bold}.highlight .w{color:#bbbbbb}.highlight .mf{color:#009999}.highlight .mh{color:#009999}.highlight .mi{color:#009999}.highlight .mo{color:#009999}.highlight .sb{color:#d01040}.highlight .sc{color:#d01040}.highlight .sd{color:#d01040}.highlight .s2{color:#d01040}.highlight .se{color:#d01040}.highlight .sh{color:#d01040}.highlight .si{color:#d01040}.highlight .sx{color:#d01040}.highlight .sr{color:#009926}.highlight .s1{color:#d01040}.highlight .ss{color:#990073}.highlight .bp{color:#999999}.highlight .vc{color:#008080}.highlight .vg{color:#008080}.highlight .vi{color:#008080}.highlight .il{color:#009999}</style></head><body><main role="main"><header role="banner"> <!--<h1 class="logo">2BAB's Engineering Blog</h1>--><nav role="navigation"><ul><li><a href="/" >文章</a></li><li><a href="https://binary.2bab.me/" >播客</a></li><li><a href="/about" >关于</a></li><li><a href="/search" >搜索</a></li><li><a href="/atom.xml" >Rss</a></li></ul></nav></header><section class="post"><h2>构建指北 #8 AppPlugin 加了代理？</h2><p><em>『构建指北』是探索 Android 构建相关的一系列文章，涵盖了 Gradle、Android Gradle Plugin、Kotlin Script 等工具，以及相关架构上的应用。以发现问题解决问题为出发点，传递新知提高生产效率为落脚点。</em></p><h3 id="问题回顾">问题回顾</h3><p>这两天在维护 <a href="https://github.com/2BAB/ScratchPaper">ScratchPaper</a> ，更新依赖的 AGP（Android Gradle Plugin）版本到 <code class="language-plaintext highlighter-rouge">3.6.1</code>。升级的过程中发现，原本项目使用到的对 <code class="language-plaintext highlighter-rouge">AppPlugin</code> 的 Hook 点失效：</p><blockquote><p>回顾下，大约是在 3.3.x-3.5.x 的版本迭代里，启用了对 <code class="language-plaintext highlighter-rouge">BuildToolInfo</code> 类的反射获取，其目的是为了获取到 Aapt2 可执行文件的所在路径，从而支持自定义重新生成 App Icon 对应的二进制文件图标。</p></blockquote><div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">me.xx2bab.scratchpaper.utils</span>

<span class="k">import</span> <span class="nn">com.android.build.gradle.AppPlugin</span>
<span class="k">import</span> <span class="nn">com.android.build.gradle.BasePlugin</span>
<span class="k">import</span> <span class="nn">com.android.build.gradle.internal.scope.GlobalScope</span>
<span class="k">import</span> <span class="nn">com.android.sdklib.BuildToolInfo</span>
<span class="k">import</span> <span class="nn">org.gradle.api.Project</span>

<span class="kd">class</span> <span class="nc">AndroidPluginUtils</span><span class="p">(</span><span class="kd">val</span> <span class="py">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">)</span> <span class="p">{</span>

    <span class="nd">@Throws</span><span class="p">(</span><span class="nc">Exception</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">buildToolInfo</span><span class="p">():</span> <span class="nc">BuildToolInfo</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">basePlugin</span> <span class="p">=</span> <span class="n">project</span><span class="p">.</span><span class="n">plugins</span><span class="p">.</span><span class="nf">findPlugin</span><span class="p">(</span><span class="nc">AppPlugin</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span> <span class="k">as</span> <span class="nc">BasePlugin</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;</span>
        <span class="kd">val</span> <span class="py">scope</span> <span class="p">=</span> <span class="nf">getField</span><span class="p">(</span><span class="nc">BasePlugin</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">,</span> <span class="n">basePlugin</span><span class="p">,</span>
                <span class="s">"globalScope"</span><span class="p">)</span> <span class="k">as</span> <span class="nc">GlobalScope</span>
        <span class="k">return</span> <span class="n">scope</span><span class="p">.</span><span class="n">sdkComponents</span><span class="p">.</span><span class="n">buildToolInfoProvider</span><span class="p">.</span><span class="k">get</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="nf">getField</span><span class="p">(</span><span class="n">clazz</span><span class="p">:</span> <span class="nc">Class</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;,</span> <span class="n">instance</span><span class="p">:</span> <span class="nc">T</span><span class="p">,</span> <span class="n">fieldName</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Any</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">field</span> <span class="p">=</span> <span class="n">clazz</span><span class="p">.</span><span class="n">declaredFields</span><span class="p">.</span><span class="nf">filter</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">name</span> <span class="p">==</span> <span class="n">fieldName</span> <span class="p">}[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">field</span><span class="p">.</span><span class="n">isAccessible</span> <span class="p">=</span> <span class="k">true</span>
        <span class="k">return</span> <span class="n">field</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="k">as</span> <span class="nc">Any</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div><p>让我们把项目依赖的 AGP 版本升级到 <code class="language-plaintext highlighter-rouge">3.6.1</code>，解决掉升级带来的常见编译错误后，跑个 Demo 试试：</p><blockquote><p>FAILURE: Build failed with an exception.</p><p>* What went wrong:</p><p>Execution failed for task ‘:app:processDemoDebugResources’.</p><p>Index: 0, Size: 0</p><p>…</p><p>Caused by: java.lang.IndexOutOfBoundsException: Index: 0, Size: 0</p><p>at me.xx2bab.scratchpaper.utils.AndroidPluginUtils.getField(AndroidPluginUtils.kt:21)</p><p>at me.xx2bab.scratchpaper.utils.AndroidPluginUtils.buildToolInfo(AndroidPluginUtils.kt:15)</p><p>at me.xx2bab.scratchpaper.utils.Aapt2Utils.compileResDir(Aapt2Utils.kt:13)</p></blockquote><p><strong>奇了怪了，为什么 <code class="language-plaintext highlighter-rouge">globalScope</code> 字段反射失败了？</strong></p><h3 id="问题分析--源码重现">问题分析 &amp; 源码重现</h3><p>第一时间，当然是查看 <code class="language-plaintext highlighter-rouge">AppPlugin</code> 和 <code class="language-plaintext highlighter-rouge">BasePlugin</code> 的源码，看看该字段是否已被移除或改名了。然而惊讶的发现，<code class="language-plaintext highlighter-rouge">BasePlugin</code> 和 <code class="language-plaintext highlighter-rouge">AppPlugin</code> 下竟然空空荡荡：</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="nn">com.android.build.gradle</span>

<span class="k">import</span> <span class="nn">org.gradle.api.Project</span>

<span class="cm">/**
 * The plugin applied with `com.android.application'
 */</span>
<span class="kd">class</span> <span class="nc">AppPlugin</span><span class="p">:</span> <span class="nc">BasePlugin</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">apply</span><span class="p">(</span><span class="n">project</span><span class="p">:</span> <span class="nc">Project</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

        <span class="n">project</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nc">INTERNAL_PLUGIN_ID</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="kd">val</span> <span class="py">INTERNAL_PLUGIN_ID</span> <span class="p">=</span> <span class="nf">mapOf</span><span class="p">(</span><span class="s">"plugin"</span> <span class="n">to</span> <span class="s">"com.android.internal.application"</span><span class="p">)</span>
</code></pre></div></div><p>真正有作用的代码只是一行内部插件的引入，插件名是 <code class="language-plaintext highlighter-rouge">com.android.internal.application</code>。顺藤摸瓜，去 <code class="language-plaintext highlighter-rouge">META-INF</code> 的插件注册目录看看，</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// com.android.internal.application.properties
implementation-class=com.android.build.gradle.internal.plugins.AppPlugin
</code></pre></div></div><p>竟然出现了另外一个 <code class="language-plaintext highlighter-rouge">AppPlugin</code>，查看对应的源码，发现之前版本的 <code class="language-plaintext highlighter-rouge">AppPlugin</code> <code class="language-plaintext highlighter-rouge">BasePlugin</code> 等等类多数被移动到 <code class="language-plaintext highlighter-rouge">com.android.build.gradle.internal.plugins</code> 包下，而现在 <code class="language-plaintext highlighter-rouge">com.android.build.gradle</code> 包下的各类 Plugin 很多只是代理了内部的各类插件。</p><p>之后，我想去找找有没有对这块改变的说明，毕竟目前的注释过于简单，没有对代理的意义做过多的说明。上 <a href="https://android.googlesource.com/platform/tools/base/+/ecdfaee5fbdfa69e82bb9266b6742d9c3db27880">GoogleSource</a> 翻到了这块相关的 commit 信息：</p><blockquote><p>New public plugin and move existing to internal.</p><p>All current plugin classes are considered public API because of how Gradle allows finding plugins. Therefore we need these classes to not change.</p><p>However, we also want to have plugin authors target gradle-api instead of the ‘gradle’ artifact. This change forks the current plugin classes into a new set of public class (name unchanged) and the actual implementations as private, internal classes.</p><p>The new public plugins delegate to the internal plugins by applying them as separate “internal” plugins. For now the public plugins stay in gradle-core but we’ll move them to gradle-api at some point. This is currently limited by the presence of getExtension on BasePlugin, both of which are now deprecated.</p><p>Because our classes have no other public API this should not break anything.</p></blockquote><p>简单来说，他们想把 <code class="language-plaintext highlighter-rouge">gradle-core</code> 和 <code class="language-plaintext highlighter-rouge">gradle-api</code> 进行区分，并让插件作者们依赖于 <code class="language-plaintext highlighter-rouge">com.android.tools.build:gradle-api</code> 而不是 <code class="language-plaintext highlighter-rouge">com.android.tools.build:gradle</code>。这个代理目前只是为了维持原有的逻辑不变，同时占个桩表示我们要开始干活了。有趣的是，原本的插件代码多使用 Java 编写，现在的这些代理类均使用 Kotlin，这也同样印证了 AGP 一轮改革的开始。</p><h3 id="解决方案">解决方案</h3><p>由于原有的逻辑都还存在于 internal 的 plugin 中，我们只要简单地替换 import 的路径即可：</p><div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.android.build.gradle.internal.plugins.AppPlugin</span>
<span class="k">import</span> <span class="nn">com.android.build.gradle.internal.plugins.BasePlugin</span>
</code></pre></div></div><p>通过 <code class="language-plaintext highlighter-rouge">findPlugin</code> 即可找到老版本的 AppPlugin 等插件。具体的修改信息可以参考这次迭代的 <a href="https://github.com/2BAB/ScratchPaper/commit/17f3e83615ca95104b735f6c541ac65df8e4962c">commit message</a>。</p><h3 id="结论">结论</h3><p>不确定之后基于 AGP 的 Hook 是否还像之前一样可操作，目前看来版本迭代的类变化更加的频繁，我自己维护的基于 AGP 的 Plugins 可能也会增加维护成本。之前考虑过的开发一个第三方的 AGP 的 Polyfill 也必须得操作起来了，分离关注点，减少插件开发和维护成本，在插件上集中注意力实现一个点的目标。</p><p><em>欢迎关注我的<a href="/about">公众号和微博</a>。</em></p><span class="meta"><time datetime="2020-03-20T00:00:00+00:00">March 20, 2020</time> &middot; <a href="/tag/Android">Android</a>, <a href="/tag/Gradle">Gradle</a>, <a href="/tag/Android Gradle Plugin">Android Gradle Plugin</a>, <a href="/tag/构建">构建</a></span> <!--<span class="meta"><time datetime="2020-03-20T00:00:00+00:00">March 20, 2020</time> &middot; <a class="post" href="/tag/Android">Android</a>, <a class="post" href="/tag/Gradle">Gradle</a>, <a class="post" href="/tag/Android Gradle Plugin">Android Gradle Plugin</a>, <a class="post" href="/tag/构建">构建</a></span> --></section></main></body><script async src="https://www.googletagmanager.com/gtag/js?id=UA-91072395-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-91072395-1'); </script></html>
