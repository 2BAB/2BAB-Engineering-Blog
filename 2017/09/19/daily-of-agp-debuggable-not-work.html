<!DOCTYPE html><html lang="en" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="构建指北 #7 debuggable 属性无效" /><meta name="author" content="2BAB" /><meta property="og:locale" content="en_US" /><meta name="description" content="『构建指北』是探索 Android 构建相关的一系列文章，涵盖了 Gradle、Android Gradle Plugin、Kotlin Script 等工具，以及相关架构上的应用。以发现问题解决问题为出发点，传递新知提高生产效率为落脚点。" /><meta property="og:description" content="『构建指北』是探索 Android 构建相关的一系列文章，涵盖了 Gradle、Android Gradle Plugin、Kotlin Script 等工具，以及相关架构上的应用。以发现问题解决问题为出发点，传递新知提高生产效率为落脚点。" /><link rel="canonical" href="https://2bab.me//2017/09/19/daily-of-agp-debuggable-not-work" /><meta property="og:url" content="https://2bab.me//2017/09/19/daily-of-agp-debuggable-not-work" /><meta property="og:site_name" content="2BAB’s Engineering Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-09-19T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="构建指北 #7 debuggable 属性无效" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@2BAB" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"2BAB","url":"https://2bab.me/"},"dateModified":"2017-09-19T00:00:00+00:00","datePublished":"2017-09-19T00:00:00+00:00","description":"『构建指北』是探索 Android 构建相关的一系列文章，涵盖了 Gradle、Android Gradle Plugin、Kotlin Script 等工具，以及相关架构上的应用。以发现问题解决问题为出发点，传递新知提高生产效率为落脚点。","headline":"构建指北 #7 debuggable 属性无效","mainEntityOfPage":{"@type":"WebPage","@id":"https://2bab.me//2017/09/19/daily-of-agp-debuggable-not-work"},"url":"https://2bab.me//2017/09/19/daily-of-agp-debuggable-not-work"}</script><title> 构建指北 #7 debuggable 属性无效 - 2BAB&#39;s Engineering Blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" title="2BAB's Engineering Blog" href="/atom.xml"><link rel="alternate" type="application/json" title="2BAB's Engineering Blog" href="https://2bab.me//feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.6;font-size:1.1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}p code{background:#f0f0f0;padding-left:0.2rem;padding-right:0.2rem}code{padding:.1rem}pre code{border:none}pre{border:1px solid #eee;padding:1rem;overflow-x:auto}blockquote{overflow-x:auto}table{display:inline-block;overflow:auto;border-collapse:collapse}table tr th,table tr td{border:1px solid #eee;padding:0.5rem}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:1rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}body{font-size:1rem}header{padding:0rem}section{padding:1rem 0 0 0}.post ul{margin-left:1rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}.highlight .hll{background-color:#ffffcc}.highlight .c{color:#999988;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{color:#000000;font-weight:bold}.highlight .o{color:#000000;font-weight:bold}.highlight .cm{color:#999988;font-style:italic}.highlight .cp{color:#999999;font-weight:bold;font-style:italic}.highlight .c1{color:#999988;font-style:italic}.highlight .cs{color:#999999;font-weight:bold;font-style:italic}.highlight .gd{color:#000000;background-color:#ffdddd}.highlight .ge{color:#000000;font-style:italic}.highlight .gr{color:#aa0000}.highlight .gh{color:#999999}.highlight .gi{color:#000000;background-color:#ddffdd}.highlight .go{color:#888888}.highlight .gp{color:#555555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaaaaa}.highlight .gt{color:#aa0000}.highlight .kc{color:#000000;font-weight:bold}.highlight .kd{color:#000000;font-weight:bold}.highlight .kn{color:#000000;font-weight:bold}.highlight .kp{color:#000000;font-weight:bold}.highlight .kr{color:#000000;font-weight:bold}.highlight .kt{color:#445588;font-weight:bold}.highlight .m{color:#009999}.highlight .s{color:#d01040}.highlight .na{color:#008080}.highlight .nb{color:#0086B3}.highlight .nc{color:#445588;font-weight:bold}.highlight .no{color:#008080}.highlight .nd{color:#3c5d5d;font-weight:bold}.highlight .ni{color:#800080}.highlight .ne{color:#990000;font-weight:bold}.highlight .nf{color:#990000;font-weight:bold}.highlight .nl{color:#990000;font-weight:bold}.highlight .nn{color:#555555}.highlight .nt{color:#000080}.highlight .nv{color:#008080}.highlight .ow{color:#000000;font-weight:bold}.highlight .w{color:#bbbbbb}.highlight .mf{color:#009999}.highlight .mh{color:#009999}.highlight .mi{color:#009999}.highlight .mo{color:#009999}.highlight .sb{color:#d01040}.highlight .sc{color:#d01040}.highlight .sd{color:#d01040}.highlight .s2{color:#d01040}.highlight .se{color:#d01040}.highlight .sh{color:#d01040}.highlight .si{color:#d01040}.highlight .sx{color:#d01040}.highlight .sr{color:#009926}.highlight .s1{color:#d01040}.highlight .ss{color:#990073}.highlight .bp{color:#999999}.highlight .vc{color:#008080}.highlight .vg{color:#008080}.highlight .vi{color:#008080}.highlight .il{color:#009999}</style></head><body><main role="main"><header role="banner"> <!--<h1 class="logo">2BAB's Engineering Blog</h1>--><nav role="navigation"><ul><li><a href="/" >文章</a></li><li><a href="https://binary.2bab.me/" >播客</a></li><li><a href="/about" >关于</a></li><li><a href="/search" >搜索</a></li><li><a href="/atom.xml" >Rss</a></li></ul></nav></header><section class="post"><h2>构建指北 #7 debuggable 属性无效</h2><p><em>『构建指北』是探索 Android 构建相关的一系列文章，涵盖了 Gradle、Android Gradle Plugin、Kotlin Script 等工具，以及相关架构上的应用。以发现问题解决问题为出发点，传递新知提高生产效率为落脚点。</em></p><h3 id="问题回顾">问题回顾</h3><p>不久前，在接手手头上这个老工程时，发现 <code class="language-plaintext highlighter-rouge">build.gradle</code> 中设置 <code class="language-plaintext highlighter-rouge">debuggable</code> 属性是无效的，只能手动在 <code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code> 的 <code class="language-plaintext highlighter-rouge">application</code> 节点写死该属性（之前团队里就这样默默干了两年，发版前去掉这个属性，发版后再加上…），最近得空花了两三个周末研究了下缘由。</p><p>默认看此文章的人已经知道这点：</p><blockquote><p>Android 系统判断一个 App 是否可 Debug 的标准是，AndroidManifest.xml 中的 application 节点是否存在 debuggable 属性，并且其值为 true。（可参考<a href="https://developer.android.com/guide/topics/manifest/application-element.html#android:debuggable">官方文档</a>）</p></blockquote><!--more--><h3 id="问题分析--源码重现">问题分析 &amp; 源码重现</h3><h4 id="0x01">0x01</h4><p>从 <code class="language-plaintext highlighter-rouge">buildType</code> 的 <code class="language-plaintext highlighter-rouge">debuggable</code> 属性开始分析追踪，既然我们知道 <code class="language-plaintext highlighter-rouge">debuggable</code> 其实会作用于 Manifest 的属性，那就找找跟 Manifest 相关的流程。先后看了 Android Gradle Plugin 中 <code class="language-plaintext highlighter-rouge">process{variant}Manifest</code>、<code class="language-plaintext highlighter-rouge">process{variant}Resources </code>、<code class="language-plaintext highlighter-rouge">package{variant}</code> 等 task 的流程，没有发现什么异常（此处不一一展开）。不过倒是对他们的中间生成产物有了些了解：</p><ul><li><code class="language-plaintext highlighter-rouge">process{variant}Manifest</code> 的 <code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code> 中间产物位于 ./app/build/intermediates/manifests 中，分为 instant-run 和 其他 variant （debug、release、etc.）等各种文件夹；</li><li><code class="language-plaintext highlighter-rouge">process{variant}Resources</code> 的 <code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code> 位于 ./app/build/intermediates/res/resources-debug.ap_ 的压缩包中（事实上一开始没有看这个 task，是在看其他 task 的中间产物时发现这个 task 其实有 <code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code> 的产物）；</li><li><code class="language-plaintext highlighter-rouge">package{variant}</code> 的 <code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code> 其实就是最后 apk 包中的文件了；</li></ul><p>除此之外，没看到有直接对 <code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code> 中写入 <code class="language-plaintext highlighter-rouge">debuggable</code> 的操作（merge 除外）。</p><h4 id="0x02">0x02</h4><p>拿一个新建的工程和问题工程作比对发现：</p><ul><li>新建工程：<code class="language-plaintext highlighter-rouge">process{variant}Manifest</code> 的产物中没有 <code class="language-plaintext highlighter-rouge">debuggable</code> 的属性，却在 <code class="language-plaintext highlighter-rouge">process{variant}Resources</code> 的产物中出现了该属性（debug 状态下为 true），说明内部操作发生在这一步；</li><li>问题工程：在所有 task 的 <code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code> 产物中，均未出现 <code class="language-plaintext highlighter-rouge">debuggable</code> 的值；</li></ul><p>看来还得再翻翻 <code class="language-plaintext highlighter-rouge">process{variant}Resources</code>，这其中主要是调用 aapt 相关的操作，仔细查看发现如下关键代码：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// AaptV1.java </span>

<span class="nd">@Override</span>
<span class="nd">@NonNull</span>
<span class="kd">protected</span> <span class="nc">ProcessInfoBuilder</span> <span class="nf">makePackageProcessBuilder</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">AaptPackageConfig</span> <span class="n">config</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">AaptException</span> <span class="o">{</span>
    <span class="nc">ProcessInfoBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProcessInfoBuilder</span><span class="o">();</span>

    <span class="cm">/*
     * AaptPackageProcessBuilder had this code below, but nothing was ever added to
     * mEnvironment.
     */</span>
    <span class="c1">//builder.addEnvironments(mEnvironment);</span>

    <span class="n">builder</span><span class="o">.</span><span class="na">setExecutable</span><span class="o">(</span><span class="n">getAaptExecutablePath</span><span class="o">());</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">addArgs</span><span class="o">(</span><span class="s">"package"</span><span class="o">);</span>

    <span class="o">...(</span><span class="n">省略无关紧要的一部分代码</span><span class="o">)</span>
    
    <span class="c1">// 在此处注入了 buildType 的 debuggable 属性</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">isDebuggable</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">addArgs</span><span class="o">(</span><span class="s">"--debug-mode"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="o">...</span>

    <span class="k">return</span> <span class="n">builder</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div><p>可以看到，在处理 aapt 的输入参数时带上了 debug 参数，随即便是调用 aapt 的外部过程，不在 Android Gradle Plugin 的控制范围内。</p><h4 id="0x03">0x03</h4><p>找出 Android SDK 源码，编译一个自己的 aapt（具体可以参考<a href="http://2bab.me/2017/09/19/android-source-development-notes-3/">这里</a>），别忘了在关键地方加上一些 log：</p><ul><li>先是入口文件，找到对应读取 <code class="language-plaintext highlighter-rouge">--debug-mode</code> 的地方，会暂存于一个 bundle 中，并且参数获取正确，为 true，[Main.cpp]:</li></ul><div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s">"-debug-mode"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"AAPTDEBUG: set debug == true"</span><span class="p">);</span>
    <span class="n">bundle</span><span class="p">.</span><span class="n">setDebugMode</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><ul><li>再者，找到 <code class="language-plaintext highlighter-rouge">bundle-&gt;getDebugMode()</code> 的地方，发现这里就是核心部分了，真正把 <code class="language-plaintext highlighter-rouge">debuggable</code> 的结果写入到 <code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code> 中；但是这里出现错误了—— <strong>application 节点获取不到，为 null</strong>，[Resource.cpp]：</li></ul><div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">status_t</span> <span class="nf">massageManifest</span><span class="p">(</span><span class="n">Bundle</span><span class="o">*</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">sp</span><span class="o">&lt;</span><span class="n">XMLNode</span><span class="o">&gt;</span> <span class="n">root</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">searchElement</span><span class="p">(</span><span class="n">String16</span><span class="p">(),</span> <span class="n">String16</span><span class="p">(</span><span class="s">"manifest"</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">root</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"No &lt;manifest&gt; tag.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">UNKNOWN_ERROR</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">// ...</span>
    
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"AAPTDEBUG: bundle-&gt;getDebugMode()"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bundle</span><span class="o">-&gt;</span><span class="n">getDebugMode</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"AAPTDEBUG: bundle-&gt;getDebugMode() - true"</span><span class="p">);</span>
        <span class="n">sp</span><span class="o">&lt;</span><span class="n">XMLNode</span><span class="o">&gt;</span> <span class="n">application</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">getChildElement</span><span class="p">(</span><span class="n">String16</span><span class="p">(),</span> <span class="n">String16</span><span class="p">(</span><span class="s">"application"</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">application</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"AAPTDEBUG: application == NULL"</span><span class="p">);</span> <span class="c1">// 问题出处，打印出了这行 log</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">application</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"AAPTDEBUG: application != NULL"</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addTagAttribute</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">RESOURCES_ANDROID_NAMESPACE</span><span class="p">,</span> <span class="s">"debuggable"</span><span class="p">,</span> <span class="s">"true"</span><span class="p">,</span>
                        <span class="n">errorOnFailedInsert</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"AAPTDEBUG: error on insert"</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">UNKNOWN_ERROR</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div><ul><li>看看 <code class="language-plaintext highlighter-rouge">getChildElement()</code> 的实现，发现上面的代码只会从 root 节点（也就是 manifest 节点）出发去找一级子节点，没有深入地递归查找，如果 application 不是 manifest 的一级子节点，则找不到，[XMLNode.cpp]：</li></ul><div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sp</span><span class="o">&lt;</span><span class="n">XMLNode</span><span class="o">&gt;</span> <span class="n">XMLNode</span><span class="o">::</span><span class="n">getChildElement</span><span class="p">(</span><span class="k">const</span> <span class="n">String16</span><span class="o">&amp;</span> <span class="n">tagNamespace</span><span class="p">,</span> <span class="k">const</span> <span class="n">String16</span><span class="o">&amp;</span> <span class="n">tagName</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"AAPTDEBUG: root -&gt; %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">String8</span><span class="p">(</span><span class="n">mElementName</span><span class="p">).</span><span class="n">string</span><span class="p">());</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">mChildren</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sp</span><span class="o">&lt;</span><span class="n">XMLNode</span><span class="o">&gt;</span> <span class="n">child</span> <span class="o">=</span> <span class="n">mChildren</span><span class="p">.</span><span class="n">itemAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span> <span class="o">==</span> <span class="n">XMLNode</span><span class="o">::</span><span class="n">TYPE_ELEMENT</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"AAPTDEBUG: getChildElement-&gt; %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">String8</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">mElementName</span><span class="p">).</span><span class="n">string</span><span class="p">());</span>
        <span class="p">}</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">getType</span><span class="p">()</span> <span class="o">==</span> <span class="n">XMLNode</span><span class="o">::</span><span class="n">TYPE_ELEMENT</span>
                <span class="o">&amp;&amp;</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">mNamespaceUri</span> <span class="o">==</span> <span class="n">tagNamespace</span>
                <span class="o">&amp;&amp;</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">mElementName</span> <span class="o">==</span> <span class="n">tagName</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">child</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p><img src="http://2bab-images.lastmayday.com/blog/2017-09-19-gradle-daily-crash-debuggable-not-work-2.jpg?imageslim" alt="" /></p><ul><li>那最后的问题就只有，为什么 application 节点不是 manifest 的一级子节点，查一下编译出来的二进制 Manifest（./app/build/intermediates/res/resources-debug.ap_ ，为避免敏感信息，这里用 <a href="https://github.com/2BAB/DebuggableTest">DebuggableTest</a> 工程做示例）：</li></ul><p><img src="http://2bab-images.lastmayday.com/blog/2017-09-19-gradle-daily-crash-debuggable-not-work-1.jpg?imageslim" alt="" /></p><ul><li>真相大白，application 的直接父节点是 namespace！</li></ul><h4 id="0x04">0x04</h4><p>查看各类依赖库的 Manifest（build-cache/exploded-aar），查看 Manifest 的合并日志（app/build/outputs/logs/manifest-merger-{variant}-report），结合之前写的一个 Manifest Precheck 插件 <a href="https://github.com/2BAB/Seal">Seal</a>，发现会碰到这个问题，有两种可能：</p><ol><li>依赖库本身对 namespace 的声明不只在 manifest 节点，例如在 application 节点声明了 android 的 namespace，可以参考我 pub 的这个 <a href="https://github.com/2BAB/DebuggableTest">DebuggableTest</a> 工程；</li><li>对 Manifest 合并前（即执行 <code class="language-plaintext highlighter-rouge">process{variant}Manifest</code> 前），如果有例如 <a href="https://github.com/2BAB/Seal">Seal</a> 这种对依赖库的 Manifest 做清洗工作，<strong>并且很巧你也用了 <code class="language-plaintext highlighter-rouge">groovy.util</code> 下的 XML 类库做 XML 解析和输出，那么恭喜你，这个库有几率会导致你的各种节点出现重复的 namespace，比如 uses-sdk 、application</strong>，不过我还没认真去排查到底什么情况下会出现这样的问题，目前实验中也只有少量的样本会这样，暂时没发现他们的共通点。</li></ol><h3 id="解决方案">解决方案</h3><ul><li><p>使用自定义的 aapt，改一行代码即可解决此类问题：将搜索 application 节点的方法从 <code class="language-plaintext highlighter-rouge">sp&lt;XMLNode&gt; XMLNode::getChildElement(const String16&amp; tagNamespace, const String16&amp; tagName)</code> 改为另外一个内建的方法 <code class="language-plaintext highlighter-rouge">sp&lt;XMLNode&gt; XMLNode::searchElement(const String16&amp; tagNamespace, const String16&amp; tagName)</code>，原因是 searchElement 的实现是会 for 循环查找所有深度子节点：</p><div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1">// Resource.cpp</span>

  <span class="n">status_t</span> <span class="nf">massageManifest</span><span class="p">(</span><span class="n">Bundle</span><span class="o">*</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">sp</span><span class="o">&lt;</span><span class="n">XMLNode</span><span class="o">&gt;</span> <span class="n">root</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">searchElement</span><span class="p">(</span><span class="n">String16</span><span class="p">(),</span> <span class="n">String16</span><span class="p">(</span><span class="s">"manifest"</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">root</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"No &lt;manifest&gt; tag.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
          <span class="k">return</span> <span class="n">UNKNOWN_ERROR</span><span class="p">;</span>
      <span class="p">}</span>
    
      <span class="p">...</span>
    
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"AAPTDEBUG: bundle-&gt;getDebugMode()"</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">bundle</span><span class="o">-&gt;</span><span class="n">getDebugMode</span><span class="p">())</span> <span class="p">{</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"AAPTDEBUG: bundle-&gt;getDebugMode() - true"</span><span class="p">);</span>
          <span class="c1">// 改掉查找方法！</span>
          <span class="n">sp</span><span class="o">&lt;</span><span class="n">XMLNode</span><span class="o">&gt;</span> <span class="n">application</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">searchElement</span><span class="p">(</span><span class="n">String16</span><span class="p">(),</span> <span class="n">String16</span><span class="p">(</span><span class="s">"application"</span><span class="p">));</span> 
          <span class="p">...</span>
      <span class="p">}</span>
      <span class="p">...</span>
 <span class="p">}</span>
   
 <span class="c1">// XMLNode.cpp</span>

  <span class="n">sp</span><span class="o">&lt;</span><span class="n">XMLNode</span><span class="o">&gt;</span> <span class="n">XMLNode</span><span class="o">::</span><span class="n">searchElement</span><span class="p">(</span><span class="k">const</span> <span class="n">String16</span><span class="o">&amp;</span> <span class="n">tagNamespace</span><span class="p">,</span> <span class="k">const</span> <span class="n">String16</span><span class="o">&amp;</span> <span class="n">tagName</span><span class="p">)</span>
  <span class="p">{</span>
    
      <span class="k">if</span> <span class="p">(</span><span class="n">getType</span><span class="p">()</span> <span class="o">==</span> <span class="n">XMLNode</span><span class="o">::</span><span class="n">TYPE_ELEMENT</span>
              <span class="o">&amp;&amp;</span> <span class="n">mNamespaceUri</span> <span class="o">==</span> <span class="n">tagNamespace</span>
              <span class="o">&amp;&amp;</span> <span class="n">mElementName</span> <span class="o">==</span> <span class="n">tagName</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// 递归实现避免上述问题</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">mChildren</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">sp</span><span class="o">&lt;</span><span class="n">XMLNode</span><span class="o">&gt;</span> <span class="n">found</span> <span class="o">=</span> <span class="n">mChildren</span><span class="p">.</span><span class="n">itemAt</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">searchElement</span><span class="p">(</span><span class="n">tagNamespace</span><span class="p">,</span> <span class="n">tagName</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="n">found</span><span class="p">;</span>
          <span class="p">}</span>
      <span class="p">}</span>
    
      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div></li><li><p>或者使用新版的 <a href="https://github.com/2BAB/Seal">Seal</a> 插件 v1.1.0 ，增加了一个配置项 <code class="language-plaintext highlighter-rouge">xmlnsSweep</code>，会在执行 <code class="language-plaintext highlighter-rouge">process{variant}Manifest</code> 之后，对其产物进行 xmlns 的清洗，避免在 manifest 节点外出现不必要的 namespace 声明，详细使用说明请参考 <a href="https://github.com/2BAB/Seal">Seal</a> 仓库的 README（注意，目前使用 Seal 请一定要开启并配置 <code class="language-plaintext highlighter-rouge">xmlnsSweep</code>，因为不能保证所有的依赖库都不会在 Precheck 中出问题）</p></li></ul><h3 id="结论">结论</h3><p>这大概是我今年研究过的最麻烦的问题了，链路长，大坑小坑不断，有 Google 挖的，有 Groovy 挖的，目前正在去给他们提 issue 的路上…</p><p>铛！更新 issue 地址： <a href="https://issuetracker.google.com/issues/66074488">https://issuetracker.google.com/issues/66074488</a> ！</p><p><em>欢迎关注我的<a href="/about">公众号和微博</a>。</em></p><span class="meta"><time datetime="2017-09-19T00:00:00+00:00">September 19, 2017</time> &middot; <a href="/tag/Android">Android</a>, <a href="/tag/Gradle">Gradle</a>, <a href="/tag/Android Gradle Plugin">Android Gradle Plugin</a>, <a href="/tag/构建">构建</a></span> <!--<span class="meta"><time datetime="2017-09-19T00:00:00+00:00">September 19, 2017</time> &middot; <a class="post" href="/tag/Android">Android</a>, <a class="post" href="/tag/Gradle">Gradle</a>, <a class="post" href="/tag/Android Gradle Plugin">Android Gradle Plugin</a>, <a class="post" href="/tag/构建">构建</a></span> --></section></main></body><script async src="https://www.googletagmanager.com/gtag/js?id=UA-91072395-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-91072395-1'); </script></html>
