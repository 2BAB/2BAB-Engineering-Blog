<!DOCTYPE html><html lang="en" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="构建指北 #10 Android 开发工具兼容性" /><meta name="author" content="2BAB" /><meta property="og:locale" content="en_US" /><meta name="description" content="『构建指北』是探索 Android 构建相关的一系列文章，涵盖了 Gradle、Android Gradle Plugin、Kotlin Script 等工具，以及相关架构上的应用。发现问题，解决问题，传递新知，提高效率。" /><meta property="og:description" content="『构建指北』是探索 Android 构建相关的一系列文章，涵盖了 Gradle、Android Gradle Plugin、Kotlin Script 等工具，以及相关架构上的应用。发现问题，解决问题，传递新知，提高效率。" /><link rel="canonical" href="https://2bab.me//2021/08/07/android-dev-tool-composition-on-m1" /><meta property="og:url" content="https://2bab.me//2021/08/07/android-dev-tool-composition-on-m1" /><meta property="og:site_name" content="2BAB’s Engineering Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-08-07T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="构建指北 #10 Android 开发工具兼容性" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@2BAB" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"2BAB","url":"https://2bab.me/"},"dateModified":"2021-08-07T00:00:00+00:00","datePublished":"2021-08-07T00:00:00+00:00","description":"『构建指北』是探索 Android 构建相关的一系列文章，涵盖了 Gradle、Android Gradle Plugin、Kotlin Script 等工具，以及相关架构上的应用。发现问题，解决问题，传递新知，提高效率。","headline":"构建指北 #10 Android 开发工具兼容性","mainEntityOfPage":{"@type":"WebPage","@id":"https://2bab.me//2021/08/07/android-dev-tool-composition-on-m1"},"url":"https://2bab.me//2021/08/07/android-dev-tool-composition-on-m1"}</script><title> 构建指北 #10 Android 开发工具兼容性 - 2BAB&#39;s Engineering Blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" title="2BAB's Engineering Blog" href="/atom.xml"><link rel="alternate" type="application/json" title="2BAB's Engineering Blog" href="https://2bab.me//feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.6;font-size:1.1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}p code{background:#f0f0f0;padding-left:0.2rem;padding-right:0.2rem}code{padding:.1rem}pre code{border:none}pre{border:1px solid #eee;padding:1rem;overflow-x:auto}blockquote{overflow-x:auto}table{display:inline-block;overflow:auto;border-collapse:collapse}table tr th,table tr td{border:1px solid #eee;padding:0.5rem}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:1rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}body{font-size:1rem}header{padding:0rem}section{padding:1rem 0 0 0}.post ul{margin-left:1rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}.highlight .hll{background-color:#ffffcc}.highlight .c{color:#999988;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{color:#000000;font-weight:bold}.highlight .o{color:#000000;font-weight:bold}.highlight .cm{color:#999988;font-style:italic}.highlight .cp{color:#999999;font-weight:bold;font-style:italic}.highlight .c1{color:#999988;font-style:italic}.highlight .cs{color:#999999;font-weight:bold;font-style:italic}.highlight .gd{color:#000000;background-color:#ffdddd}.highlight .ge{color:#000000;font-style:italic}.highlight .gr{color:#aa0000}.highlight .gh{color:#999999}.highlight .gi{color:#000000;background-color:#ddffdd}.highlight .go{color:#888888}.highlight .gp{color:#555555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaaaaa}.highlight .gt{color:#aa0000}.highlight .kc{color:#000000;font-weight:bold}.highlight .kd{color:#000000;font-weight:bold}.highlight .kn{color:#000000;font-weight:bold}.highlight .kp{color:#000000;font-weight:bold}.highlight .kr{color:#000000;font-weight:bold}.highlight .kt{color:#445588;font-weight:bold}.highlight .m{color:#009999}.highlight .s{color:#d01040}.highlight .na{color:#008080}.highlight .nb{color:#0086B3}.highlight .nc{color:#445588;font-weight:bold}.highlight .no{color:#008080}.highlight .nd{color:#3c5d5d;font-weight:bold}.highlight .ni{color:#800080}.highlight .ne{color:#990000;font-weight:bold}.highlight .nf{color:#990000;font-weight:bold}.highlight .nl{color:#990000;font-weight:bold}.highlight .nn{color:#555555}.highlight .nt{color:#000080}.highlight .nv{color:#008080}.highlight .ow{color:#000000;font-weight:bold}.highlight .w{color:#bbbbbb}.highlight .mf{color:#009999}.highlight .mh{color:#009999}.highlight .mi{color:#009999}.highlight .mo{color:#009999}.highlight .sb{color:#d01040}.highlight .sc{color:#d01040}.highlight .sd{color:#d01040}.highlight .s2{color:#d01040}.highlight .se{color:#d01040}.highlight .sh{color:#d01040}.highlight .si{color:#d01040}.highlight .sx{color:#d01040}.highlight .sr{color:#009926}.highlight .s1{color:#d01040}.highlight .ss{color:#990073}.highlight .bp{color:#999999}.highlight .vc{color:#008080}.highlight .vg{color:#008080}.highlight .vi{color:#008080}.highlight .il{color:#009999}</style></head><body><main role="main"><header role="banner"> <!--<h1 class="logo">2BAB's Engineering Blog</h1>--><nav role="navigation"><ul><li><a href="/" >文章</a></li><li><a href="https://binary.2bab.me/" >播客</a></li><li><a href="/about" >关于</a></li><li><a href="/search" >搜索</a></li><li><a href="/atom.xml" >Rss</a></li></ul></nav></header><section class="post"><h2>构建指北 #10 Android 开发工具兼容性</h2><p><em>『构建指北』是探索 Android 构建相关的一系列文章，涵盖了 Gradle、Android Gradle Plugin、Kotlin Script 等工具，以及相关架构上的应用。发现问题，解决问题，传递新知，提高效率。</em></p><p>由于几个月前电脑 CPU 烧了，被迫换了 M1 的 Mac Mini，所以整个开发环境重新搭建了一遍。趁这个机会，我想整理几个基础工具的版本搭配策略、兼容性、以及在 M1 芯片上的表现。对于版本搭配和兼容性的一些讨论不局限于当前使用的版本和平台。</p><p>下方提及的版本分别是：</p><ul><li>Zulu JDK: 11.0.11</li><li>Kotlin: 1.5.21</li><li>Gradle: 7.1.1</li><li>Android Gradle Plugin（AGP）: 7.0 &amp; 7.1</li><li>Android Studio: Arctic Fox 2020.3.1 &amp; BumbleBee 2021.1.1 Canary 6</li></ul><h2 id="jdk">JDK</h2><p><strong>自 AGP 7.0 起，JDK 11 便是最低要求</strong>。JDK 11 成为 LTS（Long-term Support) 版本已经有将近 3 年历史（Sep 2018），自身经历了 12 个小版本（11.0.12）的迭代目前相对成熟了。作为对比，上一个 LTS 的 JDK 8 2014 年发布，已经陪着我们走过了 7 年时光和 300 个小版本迭代。事实上作为 Android 开发者，即便目前项目是 Java 为主的情况，一般 Language Level 也仅 target to 1.8（一些 9-12 的特性 D8、R8 有支持，Android 11 12 也有融入）。Android 官方虽然说不会放弃 Java，但实际上对 Kotlin 的支持确实更给力。</p><p>从这个角度来看，JDK 11 带来给我们的更多是：</p><ul><li>Kotlin Compiler、Gradle、IDE 层面上性能的升级；</li><li>JDK 8 将停止维护的情况下（3 年后），安全层面的持续保障；</li><li>适应新的发布机制，每半年一个小版本，三年一个 LTS 大版本，减少历史包袱跑得更快；</li></ul><p>而 JDK 的升级策略我认为是：</p><ul><li><strong>保守派：如果不在意新语言特性，可以等每年 AGP 升级的情况来决定 JDK 的版本，因为 IDE 一般 bundle 了一个 JDK，Kotlin 编译器、Gradle 一直追着最新 JDK 并有不错的向下兼容——所以根据木桶原理等 AGP 升级了再升即可，目前看来 AGP 可能也只跟进比较稳定的 LTS 版本；</strong></li><li><strong>激进派：Gradle 支持后即可测试；</strong></li></ul><p>在 M1 Mac 上，由于 Oracle 还未有的 ARM64 版本，所以目前主流的做法是安装 <a href="https://www.azul.com/downloads/?package=jdk">Azul</a> 维护的 <code class="language-plaintext highlighter-rouge">Zulu JDK11</code>。</p><p><img src="https://2bab-images.lastmayday.com/blog/20210805160844.png?imageslim" alt="" /></p><p>需要注意的是，常用的 JDK 管理工具 <code class="language-plaintext highlighter-rouge">SDKMAN!</code> 在我的测试中依旧跑在 <code class="language-plaintext highlighter-rouge">Rosetta 2</code> 的转译环境中。这会造成即便你是安装的 <code class="language-plaintext highlighter-rouge">Zulu JDK11</code>，通过 <code class="language-plaintext highlighter-rouge">SDKMAN!</code> 的脚本启动依然会显示 Gradle <code class="language-plaintext highlighter-rouge">java</code> 的进程跑在 Intel ABI 下。故目前建议从官网下载安装，等后续配套工具支持后再考虑切换。</p><p><img src="https://2bab-images.lastmayday.com/blog/20210805162529.png?imageslim" alt="" /></p><h2 id="kotlin">Kotlin</h2><p>Kotlin 的版本搭配限制相对不多，一般我考虑三个点：</p><ul><li>有没有特别吸引人的新功能，比如刚放出稳定版的 Coroutine、Flow，或者新版本 Kotlin Multiplatform Mobile 的更好支持等；</li><li>用不用大迭代的第一个版本，例如观察刚发布时的 <code class="language-plaintext highlighter-rouge">1.4.0</code>，<code class="language-plaintext highlighter-rouge">1.5.0</code>，这条其实广泛适用于各类 Library；</li><li>Gradle 目前 bundle/test 的 Kotlin 的版本，例如最新的 7.1.1 stable 依旧是用的 <code class="language-plaintext highlighter-rouge">1.4.31</code> 的 Kotlin（7.2 RC 则跳到 <code class="language-plaintext highlighter-rouge">1.5.21</code> 了）；</li></ul><p>关于最后一点，如果使用的 Kotlin 版本和 Gradle bundle 的不一致，会出现如下 Warning：</p><blockquote><p>w: Runtime JAR files in the classpath should have the same version. &gt;These files were found in the classpath: … /Users/2bab/.gradle/caches/modules-2/files-2.1/org.jetbrains.kotlin/kotlin-stdlib-jdk7/1.4.31/84ce8e85f6e84270b2b501d44e9f0ba6ff64fa71/kotlin-stdlib-jdk7-1.4.31.jar (version 1.4) /Users/2bab/.gradle/caches/modules-2/files-2.1/org.jetbrains.kotlin/kotlin-stdlib/1.5.21/2f537cad7e9eeb9da73738c8812e1e4cf9b62e4e/kotlin-stdlib-1.5.21.jar (version 1.5) /Users/2bab/.gradle/caches/modules-2/files-2.1/org.jetbrains.kotlin/kotlin-stdlib-common/1.5.21/cc8bf3586fd2ebcf234058b9440bb406e62dfacb/kotlin-stdlib-common-1.5.21.jar (version 1.5) w: Consider providing an explicit dependency on kotlin-reflect 1.5 to prevent strange errors w: Some runtime JAR files in the classpath have an incompatible version. Consider removing them from the</p></blockquote><p>用一个简单的例子看下问题是怎么发生的：</p><pre><code class="language-Kotlin">plugins {
    id("com.android.application")
    // 没有指定版本，用的就是 Gradle bundle 的版本，
    // Gradle 7.1.1 对应的就是 Kotlin 1.4.31 的各种类库和编译工具
    kotlin("android") 
}

dependencies {
    // 而这里我们却用了 1.5.21 的最新版 Kotlin，就会出现如上问题
    implementation("org.jetbrains.kotlin:kotlin-stdlib:1.5.21")
}
</code></pre><p>解决起来也很简单：</p><pre><code class="language-Kotlin">plugins {
    id("com.android.application")
    // 手动指定版本
    kotlin("android") version "1.5.21"
}
</code></pre><p>Kotlin <a href="https://kotlinlang.org/docs/gradle.html">官方的文档</a>直接就演示了加版本号的写法。<strong>但是，这个版本是 Kotlin 基于 Gradle 测试通过，而 Gradle 自身还没有基于它<a href="https://docs.gradle.org/7.1.1/userguide/compatibility.html">测试</a>过并打包进去（见 Gradle 部分的配图），若出现了问题可能难以解决</strong>：</p><p>所以我推荐的升级策略是：</p><ul><li><strong>保守派：等 Gradle 升级的时候再升级，例如 1.5.0 到 1.5.21 中间仅隔了两个月，Gradle 就跟进了；</strong></li><li><strong>激进派：有实用的新功能或者大版本迭代后的第一个补丁版本就升。</strong></li></ul><h2 id="gradle">Gradle</h2><p>前面提到 Kotlin 的官方文档解释了各类和 Gradle 配合兼容的情况，反过来 Gradle 这边也有一个标明了 Java、Kotlin、Android 等各语言和平台的<a href="https://docs.gradle.org/7.1.1/userguide/compatibility.html">支持文档</a>。</p><p><img src="https://2bab-images.lastmayday.com/blog/20210805214442.png?imageslim" alt="" /></p><p>像前面提到的 Java 版本支持，Kotlin 版本支持在这里便一目了然。除了 Kotlin 的支持会稍落后一两个月，其他工具的最新版本兼容都不成问题。而 Gradle 自身的向下兼容我觉得还不错，我基本上每个版本都升级。而上层的 AGP DSL，特别是老版本，则挺经常有大改动（好在 7.0 后终于强多了）。</p><p>所以我推荐的升级策略是：</p><ul><li><strong>保守派：根据 AGP 的<a href="https://developer.android.com/studio/releases/gradle-plugin">文档</a>按最低版本进行升级（详见下图），例如 AGP 4.2.0+ 对应 Gradle 6.7.1+；</strong></li><li><strong>激进派：每个补丁版本(x.y.1/2/3)或者每个版本都升（Gradle 没有 -betaX 的版本习惯，一般就是 Nightly 和 RC）。</strong></li></ul><p><img src="https://2bab-images.lastmayday.com/blog/20210806211434.png?imageslim" alt="" /></p><p>另外，Gradle 7.0 后的版本原生支持了 M1，我个人的使用体验还不错。</p><h2 id="android-gradle-plugin">Android Gradle Plugin</h2><p>AGP 的版本搭配限制我们在前面基本都介绍完了，以 7.0 为例，我们来看官方 Release Note 的兼容说明：</p><p><img src="https://2bab-images.lastmayday.com/blog/20210806214019.png?imageslim" alt="" /></p><p>额外补充一点：从 AGP 7.0 起，其版本会<a href="https://android-developers.googleblog.com/2020/12/announcing-android-gradle-plugin.html">同步 Gradle 的 major 版本</a>，严格遵守 Semantic Versioning 体系（之前同步的是 AS 的版本）。也即 AGP 7.x 会适配 Gradle 7.x 的版本。不过 AGP 的发布时间依旧是随着 AS 一起发布，并且目前来看其 alpha/beta 的数字是跟随 AS 的，所以其实可以当成三者形成了某种默契的同步机制。</p><p>所以我推荐的升级策略是：</p><ul><li><strong>保守派：随 AS 正式版升级（或适当跳过第一个大版本更迭）；</strong></li><li><strong>激进派：每个版本都升，或从 alpha/beta 开始升级，例如要做 Gradle 插件适配。</strong></li></ul><h2 id="android-studio">Android Studio</h2><p>AS 基本上没有什么搭配限制，只要你用的之前正式版的 AGP，AS 就可以向下兼容。我推荐的升级策略是：</p><ul><li><strong>保守派：适当跳过第一个大版本更迭；</strong></li><li><strong>激进派：每个版本都升，或从 alpha/beta 开始升级，例如要做 IDE 插件适配或者对 Compose、调试工具新功能等有需求的。</strong></li></ul><p>另外，由于 AS 基于的 IDEA 社区版二次开发，整体稳定性、新特性支持的速度都不如 IDEA Ultimate，例如 Gradle 的 nesting Composite Build 目前就不在 AS 支持范围，见该 <a href="https://issuetracker.google.com/issues/189366120">issue</a>。</p><p>最后，自 Arctic Fox 2020.3.1 起，AS 原生支持了 M1，但如果想有更流畅的体验，我认为 BumbleBee 2021.1.1 Canary 效果更好一些。</p><h2 id="idea">IDEA</h2><p>IDEA 的主要搭配限制来自于 Android Plugin（Android IDE 插件）的版本适配。一般来说，在 AS 新的正式版本发布之后，下一个 IDEA 的正式版本就会带上该新版插件，从而对Android 开发包括 AGP 做支持。</p><p><img src="https://2bab-images.lastmayday.com/blog/20210807154410.png?imageslim" alt="" /></p><p>偶尔也有等比较久的时候，比如今年 AS&amp;AGP 4.2 在 4 月发布，而直到 7 月 IDEA 2021.2 <a href="https://www.jetbrains.com/idea/whatsnew/#Other">发布</a>时，才更新了 Android Plugin，官方的说法是 Google 放出 AGP 4.2 的源码时间晚了些，导致没赶上 2021.1 的版本。</p><p>我推荐的升级策略是：</p><ul><li><strong>保守派：仅升级正式版本；</strong></li><li><strong>激进派：从 EAP 或 RC 开始升级，例如会获得比较好的 Kotlin 支持、更早的 AGP 支持，以及 M1 平台的优化等。</strong></li></ul><p>最后，2021.2 也是让我在 M1 感觉终于不再有什么卡顿的版本了。</p><h2 id="总结">总结</h2><p>我自己由于使用 M1 的平台 + 适配一些 <a href="https://github.com/2BAB">Gradle Plugin</a>，经常会使用 beta 甚至 alpha 的 AGP（作为 Runtime 的 library），配合最新的 IDEA Ultimate 开发起来还是挺顺手。</p><p>而公司项目，现阶段 x86 平台我觉得可以使用如下配置，ARM M1 则根据上文调整对应的工具版本：</p><ul><li>JDK 11（由于 AGP 升了迟早要升级）</li><li>Gradle 7.1.1（7.2 支持 1.5.21 后可以升级）</li><li>Kotlin 1.4.31</li><li>AGP 4.2.2（7.0 稳定了新版的 Variant API，马上 7.1 也稳定新版的 DSL，不需要 Compose 的话可以观望观望）</li><li>AS 4.2.2（不需要 Compose 的话可以观望观望）</li><li>IDEA 2021.2</li></ul><p><em>欢迎关注我的<a href="/about"> Github / 公众号 / 播客 / 微博 / Twitter</a>。</em></p><span class="meta"><time datetime="2021-08-07T00:00:00+00:00">August 7, 2021</time> &middot; <a href="/tag/Android">Android</a>, <a href="/tag/Gradle">Gradle</a>, <a href="/tag/Android Gradle Plugin">Android Gradle Plugin</a>, <a href="/tag/构建">构建</a></span> <!--<span class="meta"><time datetime="2021-08-07T00:00:00+00:00">August 7, 2021</time> &middot; <a class="post" href="/tag/Android">Android</a>, <a class="post" href="/tag/Gradle">Gradle</a>, <a class="post" href="/tag/Android Gradle Plugin">Android Gradle Plugin</a>, <a class="post" href="/tag/构建">构建</a></span> --></section></main></body><script async src="https://www.googletagmanager.com/gtag/js?id=UA-91072395-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-91072395-1'); </script></html>
